# Working with QField Forms

Forms are a crucial part of QField data collection. This guide explains how to create and customize forms for optimal mobile use.

## Understanding QField Forms

QField forms are the interface through which users enter data in the field. A well-designed form:

- Is intuitive and easy to use on mobile devices
- Minimizes data entry errors
- Validates input in real-time
- Works efficiently offline
- Adapts to different screen sizes

## Form Types in QField

QField supports three form layouts:

1. **Autogenerated**: Automatically generated from layer attributes
2. **Drag-and-Drop Designer**: Custom layout designed in QGIS
3. **Custom UI**: Advanced custom forms using Qt Designer

## Configuring Forms in QGIS for QField

### Basic Form Configuration

```python
from qgis.core import QgsEditFormConfig, QgsVectorLayer

def configure_basic_form(layer):
    """Configure basic form for a layer."""
    form_config = layer.editFormConfig()
    
    # Set layout type
    form_config.setLayout(QgsEditFormConfig.GeneratedLayout)
    
    # Set suppress form (useful for simple feature creation)
    form_config.setSuppress(QgsEditFormConfig.SuppressOff)
    
    # Apply configuration
    layer.setEditFormConfig(form_config)
```

### Setting Field Properties

Configure individual field properties:

```python
from qgis.core import QgsEditorWidgetSetup

def configure_text_field(layer, field_name, multiline=False):
    """Configure text field widget."""
    form_config = layer.editFormConfig()
    
    widget_setup = QgsEditorWidgetSetup(
        'TextEdit',
        {
            'IsMultiline': multiline,
            'UseHtml': False
        }
    )
    
    form_config.setWidgetConfig(field_name, widget_setup.config())
    layer.setEditFormConfig(form_config)
```

## Common Form Widgets for QField

### 1. Text Input

```python
def configure_text_input(layer, field_name):
    """Single-line text input."""
    config = {
        'IsMultiline': False,
        'UseHtml': False
    }
    set_widget(layer, field_name, 'TextEdit', config)
```

### 2. Multiline Text

```python
def configure_multiline_text(layer, field_name):
    """Multiline text area for notes."""
    config = {
        'IsMultiline': True,
        'UseHtml': False
    }
    set_widget(layer, field_name, 'TextEdit', config)
```

### 3. Value Map (Dropdown)

```python
def configure_dropdown(layer, field_name, options):
    """Dropdown list with predefined options.
    
    :param options: Dictionary of {display_value: stored_value}
    """
    config = {
        'map': options
    }
    set_widget(layer, field_name, 'ValueMap', config)

# Example usage:
species_options = {
    'Oak': 'quercus',
    'Pine': 'pinus',
    'Birch': 'betula'
}
configure_dropdown(layer, 'species', species_options)
```

### 4. Date and Time

```python
def configure_date_field(layer, field_name):
    """Date picker widget."""
    config = {
        'display_format': 'yyyy-MM-dd',
        'field_format': 'yyyy-MM-dd',
        'calendar_popup': True
    }
    set_widget(layer, field_name, 'DateTime', config)

def configure_datetime_field(layer, field_name):
    """Date and time picker."""
    config = {
        'display_format': 'yyyy-MM-dd HH:mm:ss',
        'field_format': 'yyyy-MM-dd HH:mm:ss',
        'calendar_popup': True
    }
    set_widget(layer, field_name, 'DateTime', config)
```

### 5. Photo/Attachment

```python
def configure_photo_field(layer, field_name):
    """Photo attachment widget."""
    config = {
        'DocumentViewer': 1,
        'RelativeStorage': 1,
        'FileWidget': True,
        'UseLink': False,
        'FullUrl': False
    }
    set_widget(layer, field_name, 'ExternalResource', config)
```

### 6. Checkboxes

```python
def configure_checkbox(layer, field_name):
    """Boolean checkbox."""
    config = {
        'CheckedState': '1',
        'UncheckedState': '0'
    }
    set_widget(layer, field_name, 'CheckBox', config)
```

### 7. Range Slider

```python
def configure_range_slider(layer, field_name, min_val, max_val):
    """Range slider for numeric input."""
    config = {
        'Min': min_val,
        'Max': max_val,
        'Step': 1,
        'Style': 'Slider'
    }
    set_widget(layer, field_name, 'Range', config)
```

## Form Validation

Add validation rules to ensure data quality:

### Field Constraints

```python
def add_required_field(layer, field_name):
    """Make a field required."""
    field_idx = layer.fields().indexOf(field_name)
    if field_idx >= 0:
        layer.setFieldConstraint(
            field_idx,
            QgsFieldConstraints.ConstraintNotNull,
            QgsFieldConstraints.ConstraintStrengthHard
        )
```

### Expression-Based Validation

```python
def add_expression_constraint(layer, field_name, expression, message):
    """Add custom validation expression.
    
    :param expression: QGIS expression for validation
    :param message: Error message to display
    """
    field_idx = layer.fields().indexOf(field_name)
    if field_idx >= 0:
        layer.setConstraintExpression(field_idx, expression, message)

# Examples:
# Validate numeric range
add_expression_constraint(
    layer, 
    'age', 
    '"age" >= 0 AND "age" <= 120',
    'Age must be between 0 and 120'
)

# Validate email format
add_expression_constraint(
    layer,
    'email',
    'regexp_match("email", \'^[^@]+@[^@]+\\.[^@]+$\')',
    'Invalid email format'
)
```

## Advanced Form Features

### Field Dependencies

Create conditional field visibility:

```python
def setup_conditional_field(layer, master_field, dependent_field, condition_value):
    """Show/hide field based on another field's value."""
    form_config = layer.editFormConfig()
    
    # This requires custom form logic in QGIS 3.x
    # Use expression-based widget configuration
    pass  # Implementation depends on QGIS version
```

### Default Values

Set default values for fields:

```python
def set_default_value(layer, field_name, expression):
    """Set default value using an expression.
    
    :param expression: QGIS expression (e.g., 'now()' for current timestamp)
    """
    field_idx = layer.fields().indexOf(field_name)
    if field_idx >= 0:
        default_value_def = QgsDefaultValue(expression)
        layer.setDefaultValueDefinition(field_idx, default_value_def)

# Examples:
set_default_value(layer, 'timestamp', 'now()')
set_default_value(layer, 'user', '@user_account_name')
set_default_value(layer, 'device', '@device_id')
```

## Form Tabs and Groups

Organize forms into logical sections:

```python
from qgis.core import QgsAttributeEditorContainer, QgsAttributeEditorField

def create_tabbed_form(layer, tab_structure):
    """Create a form with tabs.
    
    :param tab_structure: Dict with tab names as keys and field lists as values
    """
    form_config = layer.editFormConfig()
    form_config.clearTabs()
    form_config.setLayout(QgsEditFormConfig.TabLayout)
    
    root = form_config.invisibleRootContainer()
    root.clear()
    
    for tab_name, field_names in tab_structure.items():
        tab = QgsAttributeEditorContainer(tab_name, root)
        
        for field_name in field_names:
            field_idx = layer.fields().indexOf(field_name)
            if field_idx >= 0:
                field_element = QgsAttributeEditorField(field_name, field_idx, tab)
                tab.addChildElement(field_element)
        
        root.addChildElement(tab)
    
    layer.setEditFormConfig(form_config)

# Example usage:
tabs = {
    'Basic Info': ['name', 'date', 'observer'],
    'Measurements': ['height', 'diameter', 'condition'],
    'Notes': ['description', 'photo']
}
create_tabbed_form(layer, tabs)
```

## Best Practices for Mobile Forms

1. **Keep it Simple**: Minimize the number of fields
2. **Use Appropriate Widgets**: Choose widgets that work well on touch screens
3. **Provide Defaults**: Pre-fill common values
4. **Add Validation**: Catch errors early
5. **Group Logically**: Organize fields into logical groups or tabs
6. **Test on Device**: Always test forms on actual mobile devices
7. **Consider Offline**: Ensure forms work without network connectivity
8. **Optimize Performance**: Avoid complex expressions that slow down form loading

## Example: Complete Form Configuration

Here's a complete example for a vegetation monitoring form:

```python
def configure_vegetation_form(layer):
    """Configure complete form for vegetation monitoring."""
    # Set basic form configuration
    form_config = layer.editFormConfig()
    form_config.setLayout(QgsEditFormConfig.TabLayout)
    
    # Configure species dropdown
    species_map = {
        'Quercus robur (Oak)': 'oak',
        'Pinus sylvestris (Pine)': 'pine',
        'Betula pendula (Birch)': 'birch',
        'Other': 'other'
    }
    configure_dropdown(layer, 'species', species_map)
    
    # Configure health condition
    health_map = {
        'Excellent': 5,
        'Good': 4,
        'Fair': 3,
        'Poor': 2,
        'Dead': 1
    }
    configure_dropdown(layer, 'health', health_map)
    
    # Configure measurements
    configure_range_slider(layer, 'height_m', 0, 50)
    configure_range_slider(layer, 'diameter_cm', 0, 200)
    
    # Configure date field
    configure_date_field(layer, 'survey_date')
    
    # Configure notes field
    configure_multiline_text(layer, 'notes')
    
    # Configure photo field
    configure_photo_field(layer, 'photo')
    
    # Set default values
    set_default_value(layer, 'survey_date', 'now()')
    set_default_value(layer, 'surveyor', '@user_account_name')
    
    # Add validation
    add_required_field(layer, 'species')
    add_required_field(layer, 'survey_date')
    add_expression_constraint(
        layer,
        'height_m',
        '"height_m" > 0',
        'Height must be positive'
    )
    
    # Create tabs
    tabs = {
        'Basic': ['species', 'survey_date', 'surveyor'],
        'Measurements': ['height_m', 'diameter_cm', 'health'],
        'Documentation': ['notes', 'photo']
    }
    create_tabbed_form(layer, tabs)
    
    layer.setEditFormConfig(form_config)
```

## Next Steps

Continue to [Data Collection and Validation](06-data-collection.md) to learn about implementing robust data validation.
